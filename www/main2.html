<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <title>main</title>

  <link rel="stylesheet" href="./static/css/common/base.css" type="text/css" />
  <link rel="stylesheet" href="./static/css/common/manage.css" type="text/css" />
  <link rel="stylesheet" href="./static/css/common/header.css" type="text/css" />
  <link rel="stylesheet" href="./static/css/common/modal.css" type="text/css" />

  <script src="js/jquery.js"></script>
  <script type="text/javascript" src="js/DIS.Web.Common.js"></script>
  <script type="text/javascript" src="js/DIS.Web.Init.js"></script>
  <script type="text/javascript" src="js/DIS.Web.Login.js"></script>
  <script type="text/javascript" src="js/DIS.Web.RequestTable.js"></script>
  <script src="./static/js/sweetalert/sweetalert.js"></script>
  <script src="./static/js/common/common.js"></script>
  <script src="./static/js/common/header.js"></script>
  <script src="modules/download.js"></script>
  <style>
    .table-fixed td {
      text-align: center;
    }

    .table-fixed thead tr th {
      padding: 10px 30px 10px 30px;
    }
  </style>
</head>

<body>
  <div class="header">
    <div class="header_content">
      <a href="/main">
        <div class="logo"></div>
      </a>
      <div class="flow">
      </div>
      <div class="menuBtn">
        <div id="myDropdown" class="dropdown-content">
          <a href="/main">홈</a>
          <a href="/log">기록 열람</a>
          <a href="/key">KEY 관리</a>
          <a href="/myInfo">내 정보</a>
          <a class="admin_only" href="/submanage">서브 계정 관리</a>
          <a id="logout">로그아웃</a>
        </div>
      </div>
    </div>
  </div>
  <div id="wrapper">
    <div class="curTenant">

    </div>
    <div>
      <br>
      <p>비식별화 요청 페이지</p>
      <a href="/decrypt">복호화 요청 페이지로 이동</a>
    </div>
    <br>
    <div class="upload-name" value="첨부파일" placeholder="첨부파일"></div>
    <br>

    <form class="fileform" method="post" enctype="multipart/form-data" accept-charset="UTF-8">
      <!-- 파일 업로드 -->
      <input type="file" id="file" value="파일 선택" name="file" />
      <div class="modalBtn">
        <!-- <button class="uploadS3" type="submit" formaction="/uploadS3">S3에 업로드</button> -->
        <br>
        <!-- <button class="uploadNAS" type="submit" formaction="/uploadNAS">NAS에 업로드</button> -->
      </div>
    </form>

    <div>
      <label><input type="checkbox" name="restoration" checked>복원 가능한 비식별화</label>
    </div>

    <div id="key_area">
      <div style="display: flex;">
        <input type="radio" name="check_key" value="0" checked="checked">보유하고 있는 인증키 이용
        <div style="display: flex; margin-left: 20px;">
          <select name="selectKeyName" id="selectKeyName">
            <option value="red">----</option>
          </select>
        </div>
      </div>
      <div>
        <input type="radio" name="check_key" value="1">새로운 인증키 생성
      </div>

      <div style="display: flex">
        <div style="display: none" id="generateKey">
          <p style="margin-left: 60px;">키 발급</p>
          <p style="margin-left: 10px;">
            <input type="text" name="genKeyName" id="genKeyName" placeholder="발급할 키 이름 입력">
          </p>

          <p style="margin-left: 10px;">
            <button class="btn" type="submit" id="genKeyBtn">RSA 키 발급</button>
          </p>
        </div>
      </div>
    </div>


    <br>
    <button class="btn" type="submit" id="uploadNASBtn">NAS에 업로드</button>
    <!-- <button class="testBtn2" type="submit">데이터베이스 생성</button> -->

    <div class="container">
      <table class="table table-fixed" id="requestListTable">
        <!-- <thead>
          <tr>
            <th class="col-xs-3">요청 번호</th>
            <th class="col-xs-3">비식별 키</th>
            <th class="col-xs-6">파일명</th>
            <th class="col-xs-6">요청 날짜</th>
            <th class="col-xs-6">진행률</th>
            <th class="col-xs-6">상태</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td class="col-xs-3">1</td>
            <td class="col-xs-3">minhh</td>
            <td class="col-xs-6">한글테스트테스트.mp4</td>
            <td class="col-xs-6">2022-08-10</td>
            <td class="col-xs-6">50%</td>
            <td class="col-xs-6">진행중</td>
          </tr>

          <tr>
            <td class="col-xs-3">1</td>
            <td class="col-xs-3">minhh</td>
            <td class="col-xs-6">한글테스트테스트.mp4</td>
            <td class="col-xs-6">2022-08-10</td>
            <td class="col-xs-6">50%</td>
            <td class="col-xs-6">진행중</td>
          </tr>
          <tr>
            <td class="col-xs-3">1</td>
            <td class="col-xs-3">minhh</td>
            <td class="col-xs-6">한글테스트테스트.mp4</td>
            <td class="col-xs-6">2022-08-10</td>
            <td class="col-xs-6">50%</td>
            <td class="col-xs-6">진행중</td>
          </tr>
          <tr>
            <td class="col-xs-3">1</td>
            <td class="col-xs-3">minhh</td>
            <td class="col-xs-6">한글테스트테스트.mp4</td>
            <td class="col-xs-6">2022-08-10</td>
            <td class="col-xs-6">50%</td>
            <td class="col-xs-6">진행중</td>
          </tr>
          <tr>
            <td class="col-xs-3">1</td>
            <td class="col-xs-3">minhh</td>
            <td class="col-xs-6">한글테스트테스트.mp4</td>
            <td class="col-xs-6">2022-08-10</td>
            <td class="col-xs-6">50%</td>
            <td class="col-xs-6">진행중</td>
          </tr>
          <tr>
            <td class="col-xs-3">1</td>
            <td class="col-xs-3">minhh</td>
            <td class="col-xs-6">한글테스트테스트.mp4</td>
            <td class="col-xs-6">2022-08-10</td>
            <td class="col-xs-6">50%</td>
            <td class="col-xs-6">진행중</td>
          </tr>
        </tbody> -->
      </table>
    </div>

    <!-- <form class="folderform" method="post" enctype="multipart/form-data">
      <input type="file" id="folder_name" value="폴더 선택" name="folder" webkitdirectory />
      <div class="modalBtn">
        <button class="upload" type="submit" id="folder_upload" formaction="/folderupload">업로드</button>
        <div class="cancel1">취소</div>
      </div>
    </form> -->
  </div>
</body>

<script>
  var fileWidth = []
  var fileHeight = []
  var videoDuration = []
  var curTime = ''
  var restoration = 1;

  function getToday() {
    var today = new Date();
    var year = today.getFullYear();
    var month = ('0' + (today.getMonth() + 1)).slice(-2);
    var day = ('0' + today.getDate()).slice(-2);

    var dateString = year + '-' + month + '-' + day;

    return dateString;
  }

  function getTime() {
    var today = new Date();
    var hours = ('0' + today.getHours()).slice(-2);
    var minutes = ('0' + today.getMinutes()).slice(-2);
    var seconds = ('0' + today.getSeconds()).slice(-2);

    var timeString = hours + ':' + minutes + ':' + seconds;

    return timeString;
  }

  function formatBytes(bytes, decimals = 2) {
    if (bytes === 0) return '0 Bytes';

    const k = 1024;
    const dm = decimals < 0 ? 0 : decimals;
    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];

    const i = Math.floor(Math.log(bytes) / Math.log(k));

    return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
  }

  function sendMessage(postData) {
    $.ajax({
      method: "post",
      url: "/api/sendMessage/encrypt",
      dataType: "json",
      data: postData,
      success: function (data) {

      },
      error: function (xhr, status) {
        // alert(xhr + " : " + status);
        alert(JSON.stringify(xhr));
      }
    });
  }

  function getFiles() {
    var files = document.getElementById("file").files;
    var myArray = {};
    var file = {};

    // manually create a new file obj for each File in the FileList
    for (var i = 0; i < files.length; i++) {
      var [ext, fileName] = files[i].name.split('.').reverse();
      file = {
        'lastMod': files[i].lastModified,
        'lastModDate': files[i].lastModifiedDate,
        'name': fileName + '-' + getToday() + '.' + ext,
        'size': files[i].size,
        'type': files[i].type,
      }
      //add the file obj to your array
      myArray[i] = file
    }
    //stringify array
    return JSON.stringify(myArray);
  }

  function uploadFile(postData) {
    var formData = new FormData();
    var file = document.getElementById('file').files[0];
    // curTime = getTime();
    // syncTime(curTime)

    if (file == undefined) {
      alert("파일을 선택해 주세요")
    }
    else if ($('#selectKeyName').val() == '0' && restoration == 1) alert('사용할 키를 선택해 주세요')
    else {
      formData.append('file', file);
      var xhr = new XMLHttpRequest();
      xhr.open('post', '/api/uploadNAS', true);
      xhr.upload.onprogress = function (e) {
        if (e.lengthComputable) {
          var percentage = (e.loaded / e.total) * 100;
          console.log(percentage + "%");
        }
      }
      xhr.onerror = function (e) {
        console.log('Error');
        console.log(e);
      };
      xhr.onload = function () {
        new Promise((resolve, reject) => {
          var requestIndex = storeRequestInfo(postData)
          postData['requestIndex'] = requestIndex;
          resolve();
        }).then(() => {
          sendMessage(postData)
          new Promise((resolve, reject) => {
            resolve()
          }).then((a) => {
            alert('NAS에 업로드 완료');
            location.href = '/main'
          })
        })
      };
      xhr.send(formData);
    }
  }

  function syncTimeAndUpload(time) {
    const files = document.getElementById("file").files;

    var fileNameList = getFiles();
    var fileWidthObj = Object.assign({}, fileWidth)
    var fileHeightObj = Object.assign({}, fileHeight)
    var videoDurationObj = Object.assign({}, videoDuration)

    var keyIndex = 0;
    var keyName = 'null';
    if (restoration == 1) {
      keyIndex = $('#selectKeyName').val()
      keyName = $('#selectKeyName option:checked').text()
    }

    var postData = {
      'requestType': 'encrypt',
      'fileNameList': fileNameList,
      'fileWidth': JSON.stringify(fileWidthObj),
      'fileHeight': JSON.stringify(fileHeightObj),
      'videoDuration': JSON.stringify(videoDurationObj),
      'curTime': curTime,
      'keyIndex': keyIndex,
      'keyName': keyName,
      'requestIndex': '',
      'restoration': restoration,
    }

    $.ajax({
      method: "post",
      url: "/api/syncTime",
      dataType: "json",
      data: {
        'curTime': time
      },
      success: function (data) {
        uploadFile(postData)
      },
      error: function (xhr, status) {
        // alert(xhr + " : " + status);
        alert(JSON.stringify(xhr));
      }
    });
  }

  function storeRequestInfo(postData) {
    var result = ''
    $.ajax({
      method: "post",
      url: "/api/request/encrypt",
      dataType: "json",
      data: postData,
      async: false,
      success: function (data) {
        result = data.enc_request_list_id;
      },
      error: function (xhr, status) {
        // alert(xhr + " : " + status);
        alert(JSON.stringify(xhr));
      }
    });

    return result;
  }

  $("#file").on('change', function () {
    const files = document.getElementById("file").files;

    var fileTypeInfo = ''
    var fileType = []
    var fileExt = []
    fileWidth = []
    fileHeight = []
    // curTime = getTime();
    // syncTime(curTime)

    for (var i = 0; i < files.length; i++) {
      fileTypeInfo = files[i].type.split('/');
      fileType.push(fileTypeInfo[0])
      fileExt.push(fileTypeInfo[1])
    }

    for (var i = 0; i < files.length; i++) {
      if (fileType[i] == 'image') {
        let img = new Image()
        img.src = window.URL.createObjectURL(files[i])
        img.onload = () => {
          alert(img.width + " " + img.height);
          fileWidth.push(img.width);
          fileHeight.push(img.height);
        }
      }
      else if (fileType[i] == 'video') {
        const video = document.createElement('video')
        video.addEventListener('loadedmetadata', event => {
          fileWidth.push(video.videoWidth);
          fileHeight.push(video.videoHeight);
          videoDuration.push(video.duration);
        });
        video.src = URL.createObjectURL(this.files[i]);
      }
    }

    var fileList = ''
    for (var i = 0; i < files.length; i++) {
      fileList += '파일 이름: ' + files[i].name + '<br>'
        + '크기: ' + formatBytes(files[i].size) + '<br>'
        + '종류: ' + fileType[i] + '<br>'
    }
    $(".upload-name").html(fileList);
    console.log(fileWidth);
  });

  $('#uploadNASBtn').on("click", function () {
    curTime = getTime();
    syncTimeAndUpload(curTime)
  })

  $('.testBtn2').on("click", function () {
    $.ajax({
      method: "get",
      url: "/api/createDatabase",
      success: function (data) {
        alert(JSON.stringify(data))
      },
      error: function (xhr, status) {
        alert(JSON.stringify(xhr) + JSON.stringify(status));
      }
    });
  })

  $('input[type=radio][name=check_key]').on('change', function () {
    switch ($(this).val()) {
      case '0':
        $('#selectKeyName').css('display', 'block');
        $('#generateKey').css('display', 'none');
        break;
      case '1':
        $('#selectKeyName').css('display', 'none');
        $('#generateKey').css('display', 'flex');
        break;
    }
  });

  $('#genKeyBtn').on("click", function () {
    var genKeyName = $("#genKeyName").val();
    $.ajax({
      method: "post",
      url: "/api/key",
      data: { 'keyName': genKeyName },
      success: function (data) {
        // alert(JSON.stringify(data));
        new Promise((resolve, reject) => {
          download(data.privateKey, data.keyName + ".pem", "text/plain")
          resolve();
        }).then(() => {
          alert('RSA 키 발급 완료');
          location.href = '/main'
        })
      },
      error: function (xhr, status) {
        alert(JSON.stringify(xhr) + JSON.stringify(status));
      }
    });
  })

  $('input[type=checkbox][name=restoration]').on('change', function () {
    switch ($(this)[0].checked) {
      case true:
        restoration = 1;
        $('#key_area').css('display', 'block');
        break;
      case false:
        restoration = 0;
        $('#key_area').css('display', 'none');
        break;
    }
  });
</script>

</html>